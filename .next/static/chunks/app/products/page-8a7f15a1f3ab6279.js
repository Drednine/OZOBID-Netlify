(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[286],{1407:function(e,t,s){Promise.resolve().then(s.bind(s,7270))},7270:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return page}});var r=s(7437),a=s(2265),l=s(7295),c=s(7823),components_ProductExportPage=e=>{let{userId:t,credentials:s}=e,[i,d]=(0,a.useState)(!1),[n,o]=(0,a.useState)(""),[u,x]=(0,a.useState)("success"),[h,m]=(0,a.useState)([]),[p,g]=(0,a.useState)([]),[b,f]=(0,a.useState)([]),[j,y]=(0,a.useState)(""),[v,w]=(0,a.useState)(""),[N,_]=(0,a.useState)("all"),[k,S]=(0,a.useState)("name"),[C,P]=(0,a.useState)("asc"),[E,O]=(0,a.useState)(1),[L,U]=(0,a.useState)(1),[z,F]=(0,a.useState)(!1),[I,K]=(0,a.useState)(new Set),[A,M]=(0,a.useState)(!1);(0,a.useEffect)(()=>{loadCategories(),loadProducts()},[t,s]),(0,a.useEffect)(()=>{applyFilters()},[h,j,v,N,k,C]);let loadCategories=async()=>{try{F(!0);let{data:e,error:t}=await (0,l.CP)(s);if(t)throw Error("Ошибка при загрузке категорий: "+t);e&&e.result&&f(e.result)}catch(e){o(e.message),x("error")}finally{F(!1)}},loadProducts=async()=>{try{d(!0),o("");let e={};j&&(e.category_id=parseInt(j)),v&&(e.search=v);let{data:t,error:r}=await (0,l.jw)(s,e,1e3,0);if(r)throw Error("Ошибка при загрузке списка товаров: "+r);if(!t||!t.result||!t.result.items){m([]),o("Товары не найдены"),x("warning");return}let a=t.result.items.map(e=>e.product_id);if(0===a.length){m([]),o("Товары не найдены"),x("warning");return}let{data:c,error:i}=await (0,l.Cn)(s,a);if(i)throw Error("Ошибка при загрузке информации о товарах: "+i);let{data:n,error:u}=await (0,l.h_)(s,a);if(u)throw Error("Ошибка при загрузке информации об остатках: "+u);let{data:h,error:p}=await (0,l.o$)(s,a);if(p)throw Error("Ошибка при загрузке информации о ценах: "+p);let g=[];c&&c.result&&c.result.items&&c.result.items.forEach(e=>{var t,s,r,a,l,c,i,d;let o=null==n?void 0:null===(s=n.result)||void 0===s?void 0:null===(t=s.items)||void 0===t?void 0:t.find(t=>t.product_id===e.product_id),u=null==h?void 0:null===(a=h.result)||void 0===a?void 0:null===(r=a.items)||void 0===r?void 0:r.find(t=>t.product_id===e.product_id);g.push({product_id:e.product_id,offer_id:e.offer_id||"",name:e.name||"Без названия",category:e.category||"Без категории",price:(null==u?void 0:null===(l=u.price)||void 0===l?void 0:l.price)||0,old_price:null==u?void 0:null===(c=u.price)||void 0===c?void 0:c.old_price,stock:(null==o?void 0:null===(i=o.stocks)||void 0===i?void 0:i.reduce((e,t)=>e+t.present,0))||0,sku:e.sku||"",image_url:(null===(d=e.images)||void 0===d?void 0:d[0])||"",status:e.status||"inactive"})}),m(g),0===g.length?(o("Товары не найдены"),x("warning")):(o("Загружено ".concat(g.length," товаров")),x("success"))}catch(e){o(e.message),x("error")}finally{d(!1)}},applyFilters=()=>{let e=[...h];if(j&&(e=e.filter(e=>e.category.toLowerCase().includes(j.toLowerCase()))),v){let t=v.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.sku.toLowerCase().includes(t)||e.offer_id.toLowerCase().includes(t))}"in-stock"===N?e=e.filter(e=>e.stock>0):"out-of-stock"===N&&(e=e.filter(e=>0===e.stock)),e.sort((e,t)=>"name"===k?"asc"===C?e.name.localeCompare(t.name):t.name.localeCompare(e.name):"price"===k?"asc"===C?e.price-t.price:t.price-e.price:"stock"===k?"asc"===C?e.stock-t.stock:t.stock-e.stock:0),g(e),U(Math.ceil(e.length/20)),O(1)},getCurrentPageProducts=()=>{let e=(E-1)*20,t=e+20;return p.slice(e,t)},handleProductSelect=e=>{let t=new Set(I);t.has(e)?t.delete(e):t.add(e),K(t)},saveSelectedProducts=async()=>{if(0===I.size){o("Не выбрано ни одного товара"),x("warning");return}try{d(!0);let e=h.filter(e=>I.has(e.product_id)),{error:s}=await c.OQ.from("exported_products").upsert(e.map(e=>({user_id:t,product_id:e.product_id,offer_id:e.offer_id,name:e.name,category:e.category,price:e.price,old_price:e.old_price||null,stock:e.stock,sku:e.sku,image_url:e.image_url||null,status:e.status,exported_at:new Date().toISOString()})));if(s)throw Error("Ошибка при сохранении товаров: "+s.message);o("Успешно сохранено ".concat(I.size," товаров")),x("success")}catch(e){o(e.message),x("error")}finally{d(!1)}},formatPrice=e=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:2}).format(e);return(0,r.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,r.jsx)("h1",{className:"text-3xl font-bold mb-6",children:"Выгрузка товаров"}),n&&(0,r.jsx)("div",{className:"p-4 mb-4 rounded ".concat("error"===u?"bg-red-100 text-red-700":"warning"===u?"bg-yellow-100 text-yellow-700":"bg-green-100 text-green-700"),children:n}),(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md mb-6",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Фильтры и поиск"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 mb-2",children:"Категория"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:j,onChange:e=>y(e.target.value),children:[(0,r.jsx)("option",{value:"",children:"Все категории"}),b.map(e=>(0,r.jsx)("option",{value:e.category_id,children:e.title},e.category_id))]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 mb-2",children:"Поиск по названию/SKU"}),(0,r.jsx)("input",{type:"text",className:"w-full px-3 py-2 border rounded-md",placeholder:"Введите название или SKU",value:v,onChange:e=>w(e.target.value)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 mb-2",children:"Наличие"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:N,onChange:e=>_(e.target.value),children:[(0,r.jsx)("option",{value:"all",children:"Все товары"}),(0,r.jsx)("option",{value:"in-stock",children:"В наличии"}),(0,r.jsx)("option",{value:"out-of-stock",children:"Нет в наличии"})]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 mb-2",children:"Сортировка"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:k,onChange:e=>S(e.target.value),children:[(0,r.jsx)("option",{value:"name",children:"По названию"}),(0,r.jsx)("option",{value:"price",children:"По цене"}),(0,r.jsx)("option",{value:"stock",children:"По остатку"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-gray-700 mb-2",children:"Порядок"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:C,onChange:e=>P(e.target.value),children:[(0,r.jsx)("option",{value:"asc",children:"По возрастанию"}),(0,r.jsx)("option",{value:"desc",children:"По убыванию"})]})]})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("button",{onClick:loadProducts,className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",disabled:i,children:i?"Загрузка...":"Обновить товары"}),(0,r.jsx)("button",{onClick:saveSelectedProducts,className:"bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded",disabled:i||0===I.size,children:i?"Сохранение...":"Сохранить выбранные (".concat(I.size,")")})]})]}),(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Список товаров"}),(0,r.jsxs)("div",{className:"text-gray-600",children:["Всего: ",p.length," товаров"]})]}),p.length>0?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"min-w-full bg-white",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"bg-gray-100",children:[(0,r.jsx)("th",{className:"py-2 px-3 text-left",children:(0,r.jsx)("input",{type:"checkbox",checked:A,onChange:()=>{let e=!A;M(e);let t=new Set(I),s=getCurrentPageProducts();e?s.forEach(e=>{t.add(e.product_id)}):s.forEach(e=>{t.delete(e.product_id)}),K(t)}})}),(0,r.jsx)("th",{className:"py-2 px-3 text-left",children:"Фото"}),(0,r.jsx)("th",{className:"py-2 px-3 text-left",children:"Название"}),(0,r.jsx)("th",{className:"py-2 px-3 text-left",children:"SKU"}),(0,r.jsx)("th",{className:"py-2 px-3 text-left",children:"Категория"}),(0,r.jsx)("th",{className:"py-2 px-3 text-right",children:"Цена"}),(0,r.jsx)("th",{className:"py-2 px-3 text-right",children:"Остаток"}),(0,r.jsx)("th",{className:"py-2 px-3 text-center",children:"Статус"})]})}),(0,r.jsx)("tbody",{children:getCurrentPageProducts().map(e=>(0,r.jsxs)("tr",{className:"border-b hover:bg-gray-50",children:[(0,r.jsx)("td",{className:"py-2 px-3",children:(0,r.jsx)("input",{type:"checkbox",checked:I.has(e.product_id),onChange:()=>handleProductSelect(e.product_id)})}),(0,r.jsx)("td",{className:"py-2 px-3",children:e.image_url?(0,r.jsx)("img",{src:e.image_url,alt:e.name,className:"w-12 h-12 object-contain"}):(0,r.jsx)("div",{className:"w-12 h-12 bg-gray-200 flex items-center justify-center",children:(0,r.jsx)("span",{className:"text-gray-400 text-xs",children:"Нет фото"})})}),(0,r.jsx)("td",{className:"py-2 px-3",children:e.name}),(0,r.jsx)("td",{className:"py-2 px-3",children:e.sku}),(0,r.jsx)("td",{className:"py-2 px-3",children:e.category}),(0,r.jsxs)("td",{className:"py-2 px-3 text-right",children:[formatPrice(e.price),e.old_price&&(0,r.jsx)("div",{className:"text-gray-400 line-through text-xs",children:formatPrice(e.old_price)})]}),(0,r.jsx)("td",{className:"py-2 px-3 text-right",children:(0,r.jsx)("span",{className:e.stock>0?"text-green-600":"text-red-600",children:e.stock})}),(0,r.jsx)("td",{className:"py-2 px-3 text-center",children:(0,r.jsx)("span",{className:"px-2 py-1 rounded text-xs ".concat("active"===e.status?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"),children:"active"===e.status?"Активен":"Неактивен"})})]},e.product_id))})]})}),L>1&&(0,r.jsx)("div",{className:"flex justify-center mt-6",children:(0,r.jsxs)("nav",{className:"flex items-center",children:[(0,r.jsx)("button",{onClick:()=>O(e=>Math.max(e-1,1)),disabled:1===E,className:"px-3 py-1 rounded-l border bg-white disabled:opacity-50",children:"\xab"}),Array.from({length:L},(e,t)=>t+1).map(e=>(0,r.jsx)("button",{onClick:()=>O(e),className:"px-3 py-1 border-t border-b ".concat(E===e?"bg-blue-500 text-white":"bg-white"),children:e},e)),(0,r.jsx)("button",{onClick:()=>O(e=>Math.min(e+1,L)),disabled:E===L,className:"px-3 py-1 rounded-r border bg-white disabled:opacity-50",children:"\xbb"})]})})]}):(0,r.jsx)("div",{className:"text-center py-8 text-gray-500",children:i?(0,r.jsx)("div",{className:"flex justify-center items-center",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):"Нет товаров для отображения"})]})]})},page=()=>{let[e,t]=(0,a.useState)(null),[s,l]=(0,a.useState)(null),[i,d]=(0,a.useState)(!0),[n,o]=(0,a.useState)(null);return((0,a.useEffect)(()=>{let checkAuth=async()=>{try{d(!0);let{data:{user:e},error:s}=await c.OQ.auth.getUser();if(s)throw Error("Ошибка авторизации: "+s.message);if(!e)throw Error("Необходимо авторизоваться");t(e.id);let{data:r,error:a}=await c.OQ.from("ozon_credentials").select("*").eq("user_id",e.id).eq("is_active",!0).single();if(a&&"PGRST116"!==a.code)throw Error("Ошибка при получении учетных данных: "+a.message);if(!r)throw Error("Необходимо добавить учетные данные OZON");l({clientId:r.client_id,apiKey:r.api_key})}catch(e){o(e.message)}finally{d(!1)}};checkAuth()},[]),i)?(0,r.jsx)("div",{className:"flex justify-center items-center min-h-screen",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):n?(0,r.jsxs)("div",{className:"max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md",children:[(0,r.jsx)("div",{className:"text-red-500 mb-4",children:n}),(0,r.jsx)("button",{onClick:()=>window.location.href="/",className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",children:"Вернуться на главную"})]}):(0,r.jsx)("div",{className:"container mx-auto px-4 py-8",children:e&&s&&(0,r.jsx)(components_ProductExportPage,{userId:e,credentials:s})})}}},function(e){e.O(0,[921,50,971,472,744],function(){return e(e.s=1407)}),_N_E=e.O()}]);