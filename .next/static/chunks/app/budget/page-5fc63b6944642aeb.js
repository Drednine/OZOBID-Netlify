(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[379],{9648:function(e,t,a){Promise.resolve().then(a.bind(a,6280))},6280:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return page}});var s=a(7437),i=a(2265),l=a(1865),r=a(7295),d=a(7823),components_BudgetMonitor=e=>{let{userId:t,storeId:a,credentials:l,performanceCredentials:n,dailyLimit:c,warningThreshold:o,autoDisable:m,onBudgetExceeded:u}=e,[x,h]=(0,i.useState)(0),[g,b]=(0,i.useState)(0),[p,f]=(0,i.useState)(!1),[y,j]=(0,i.useState)(!1),[w,_]=(0,i.useState)(!1),[N,v]=(0,i.useState)(null),[S,k]=(0,i.useState)(null),checkBudget=async()=>{_(!0),k(null);try{let{data:e,error:s}=await d.OQ.from("budget_monitoring").select("*").eq("user_id",t).eq("store_id",a).single();if(s)throw Error(s.message);if(m){let{data:e,error:s}=await (0,r.aj)(l,n,c,m);if(s)throw Error(s);e&&(h(e.totalSpent||0),b((e.totalSpent||0)/c*100),f((e.totalSpent||0)>=c*o/100),j(e.budgetExceeded||!1),v(new Date().toISOString()),e.budgetExceeded&&u&&u(),await d.OQ.from("budget_monitoring").upsert({user_id:t,store_id:a,total_spent:e.totalSpent||0,budget_exceeded:e.budgetExceeded||!1,last_checked:new Date().toISOString()}))}else e&&(h(e.total_spent||0),b((e.total_spent||0)/c*100),f((e.total_spent||0)>=c*o/100),j(e.budget_exceeded||!1),v(e.last_checked))}catch(e){k("Ошибка при проверке бюджета: ".concat(e.message))}finally{_(!1)}};return(0,i.useEffect)(()=>{checkBudget();let e=setInterval(checkBudget,18e5);return()=>clearInterval(e)},[t,a,c,o,m]),(0,s.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"Мониторинг дневного бюджета"}),S&&(0,s.jsx)("div",{className:"p-4 mb-4 rounded bg-red-100 text-red-700",children:S}),(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsxs)("div",{className:"flex justify-between mb-2",children:[(0,s.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["Потрачено: ",x.toFixed(2)," ₽ из ",c.toFixed(2)," ₽"]}),(0,s.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:[g.toFixed(1),"%"]})]}),(0,s.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:(0,s.jsx)("div",{className:"h-2.5 rounded-full ".concat(y?"bg-red-600":p?"bg-yellow-500":"bg-green-600"),style:{width:"".concat(Math.min(g,100),"%")}})})]}),(0,s.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-center mb-4",children:[(0,s.jsx)("div",{className:"mb-4 md:mb-0",children:(0,s.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat(y?"bg-red-100 text-red-800":p?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"),children:y?"Бюджет превышен":p?"Приближается к лимиту":"В пределах бюджета"})}),(0,s.jsx)("div",{className:"text-sm text-gray-500",children:N&&"Последняя проверка: ".concat(new Date(N).toLocaleString())})]}),(0,s.jsx)("button",{onClick:checkBudget,disabled:w,className:"w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 disabled:opacity-50",children:w?"Проверка...":"Проверить сейчас"})]})},components_BudgetSettingsForm=e=>{let{userId:t,credentials:a}=e,[n,c]=(0,i.useState)([]),[o,m]=(0,i.useState)(!1),[u,x]=(0,i.useState)(""),[h,g]=(0,i.useState)(null),[b,p]=(0,i.useState)(!1),[f,y]=(0,i.useState)("default"),[j,w]=(0,i.useState)({clientId:a.clientId,apiKey:a.apiKey}),{register:_,handleSubmit:N,setValue:v,watch:S,formState:{errors:k}}=(0,l.cI)(),E=S("isActive"),B=S("dailyLimit")||0,I=S("notificationThreshold")||80;(0,i.useEffect)(()=>{let loadData=async()=>{m(!0);let{data:e,error:s}=await (0,r.x)(a);s?x("Ошибка при загрузке кампаний: "+s.message):e&&c(e.campaigns||[]);let{data:i,error:l}=await (0,d.m1)(t);l?x("Ошибка при загрузке настроек бюджета: "+l.message):i&&(v("dailyLimit",i.daily_limit||0),v("notificationThreshold",i.notification_threshold||80),v("isActive",void 0===i.is_active||i.is_active),i.store_id&&y(i.store_id),i.performance_client_id&&i.performance_api_key&&w({clientId:i.performance_client_id,apiKey:i.performance_api_key})),m(!1)};loadData()},[t,a,v]);let handleCampaignSelect=e=>{g(e);let t=n.find(t=>t.id===e);t&&v("campaignBudget",t.dailyBudget||0)},onSubmit=async e=>{m(!0),x("");try{let{error:s}=await (0,d.rO)(t,{daily_limit:e.dailyLimit,notification_threshold:e.notificationThreshold,is_active:e.isActive,store_id:f,performance_client_id:j.clientId,performance_api_key:j.apiKey});if(s)throw Error("Ошибка при обновлении настроек бюджета: "+s.message);if(h){let{error:t}=await (0,r.kC)(a,h,e.campaignBudget);if(t)throw Error("Ошибка при обновлении бюджета кампании: "+t.message)}x("Настройки бюджета успешно обновлены")}catch(e){x(e.message)}finally{m(!1)}};return(0,s.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-6",children:"Настройки бюджета"}),u&&(0,s.jsx)("div",{className:"p-4 mb-4 rounded ".concat(u.includes("Ошибка")?"bg-red-100 text-red-700":"bg-green-100 text-green-700"),children:u}),(0,s.jsxs)("form",{onSubmit:N(onSubmit),children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-gray-700 mb-2",children:"Общий дневной лимит (руб.)"}),(0,s.jsx)("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",..._("dailyLimit",{required:"Это поле обязательно",min:{value:0,message:"Значение должно быть положительным"}})}),k.dailyLimit&&(0,s.jsx)("p",{className:"text-red-500 mt-1",children:k.dailyLimit.message})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-gray-700 mb-2",children:"Порог уведомления (%)"}),(0,s.jsx)("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",..._("notificationThreshold",{required:"Это поле обязательно",min:{value:1,message:"Минимальное значение 1%"},max:{value:100,message:"Максимальное значение 100%"}})}),k.notificationThreshold&&(0,s.jsx)("p",{className:"text-red-500 mt-1",children:k.notificationThreshold.message})]}),(0,s.jsx)("div",{className:"mb-4",children:(0,s.jsxs)("label",{className:"flex items-center text-gray-700 mb-2",children:[(0,s.jsx)("input",{type:"checkbox",className:"mr-2",..._("isActive")}),"Автоматически отключать кампании при превышении лимита"]})}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-gray-700 mb-2",children:"Выберите кампанию для настройки бюджета"}),(0,s.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",onChange:e=>handleCampaignSelect(e.target.value),defaultValue:"",children:[(0,s.jsx)("option",{value:"",disabled:!0,children:"Выберите кампанию"}),n.map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.name," (","active"===e.state?"активна":"приостановлена",")"]},e.id))]})]}),h&&(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-gray-700 mb-2",children:"Дневной бюджет кампании (руб.)"}),(0,s.jsx)("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",..._("campaignBudget",{required:"Это поле обязательно",min:{value:0,message:"Значение должно быть положительным"}})}),k.campaignBudget&&(0,s.jsx)("p",{className:"text-red-500 mt-1",children:k.campaignBudget.message})]}),(0,s.jsx)("button",{type:"submit",className:"w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md",disabled:o,children:o?"Сохранение...":"Сохранить настройки"}),(0,s.jsx)("button",{type:"button",className:"w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md",onClick:()=>p(!b),children:b?"Скрыть мониторинг":"Показать мониторинг"})]})]}),b&&(0,s.jsx)("div",{children:(0,s.jsx)(components_BudgetMonitor,{userId:t,storeId:f,credentials:a,performanceCredentials:j,dailyLimit:B,warningThreshold:I,autoDisable:E})})]})})},page=()=>{let[e,t]=(0,i.useState)(null),[a,l]=(0,i.useState)(null),[r,n]=(0,i.useState)(!0),[c,o]=(0,i.useState)(null);return((0,i.useEffect)(()=>{let checkAuth=async()=>{try{n(!0);let{data:{user:e},error:a}=await d.OQ.auth.getUser();if(a)throw Error("Ошибка авторизации: "+a.message);if(!e)throw Error("Необходимо авторизоваться");t(e.id);let{data:s,error:i}=await d.OQ.from("ozon_credentials").select("*").eq("user_id",e.id).eq("is_active",!0).single();if(i&&"PGRST116"!==i.code)throw Error("Ошибка при получении учетных данных: "+i.message);if(!s)throw Error("Необходимо добавить учетные данные OZON");l({clientId:s.client_id,apiKey:s.api_key})}catch(e){o(e.message)}finally{n(!1)}};checkAuth()},[]),r)?(0,s.jsx)("div",{className:"flex justify-center items-center min-h-screen",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):c?(0,s.jsxs)("div",{className:"max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md",children:[(0,s.jsx)("div",{className:"text-red-500 mb-4",children:c}),(0,s.jsx)("button",{onClick:()=>window.location.href="/",className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",children:"Вернуться на главную"})]}):(0,s.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-8",children:"Управление бюджетом"}),e&&a&&(0,s.jsx)(components_BudgetSettingsForm,{userId:e,credentials:a})]})}}},function(e){e.O(0,[921,865,50,971,472,744],function(){return e(e.s=9648)}),_N_E=e.O()}]);