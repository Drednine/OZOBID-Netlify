(()=>{var e={};e.id=286,e.ids=[286],e.modules={5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},5528:e=>{"use strict";e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},1877:e=>{"use strict";e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},5319:e=>{"use strict";e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},9491:e=>{"use strict";e.exports=require("assert")},4300:e=>{"use strict";e.exports=require("buffer")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},8832:(e,t,r)=>{"use strict";r.r(t),r.d(t,{GlobalError:()=>i.a,__next_app__:()=>x,originalPathname:()=>u,pages:()=>n,routeModule:()=>p,tree:()=>d});var s=r(7096),a=r(6132),l=r(7284),i=r.n(l),c=r(2564),o={};for(let e in c)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>c[e]);r.d(t,o);let d=["",{children:["products",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,4302)),"F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\products\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,9113)),"F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,9291,23)),"next/dist/client/components/not-found-error"]}],n=["F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\products\\page.tsx"],u="/products/page",x={require:r,loadChunk:()=>Promise.resolve()},p=new s.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/products/page",pathname:"/products",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},8578:(e,t,r)=>{Promise.resolve().then(r.bind(r,5307))},5307:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>page});var s=r(784),a=r(9885),l=r(9994),i=r(5413);let components_ProductExportPage=({userId:e,credentials:t})=>{let[r,c]=(0,a.useState)(!1),[o,d]=(0,a.useState)(""),[n,u]=(0,a.useState)("success"),[x,p]=(0,a.useState)([]),[h,m]=(0,a.useState)([]),[g,b]=(0,a.useState)([]),[y,f]=(0,a.useState)(""),[j,w]=(0,a.useState)(""),[_,v]=(0,a.useState)("all"),[N,k]=(0,a.useState)("name"),[P,S]=(0,a.useState)("asc"),[C,q]=(0,a.useState)(1),[O,E]=(0,a.useState)(1),[I,D]=(0,a.useState)(!1),[B,F]=(0,a.useState)(new Set),[Z,$]=(0,a.useState)(!1);(0,a.useEffect)(()=>{loadCategories(),loadProducts()},[e,t]),(0,a.useEffect)(()=>{applyFilters()},[x,y,j,_,N,P]);let loadCategories=async()=>{try{D(!0);let{data:e,error:r}=await (0,l.CP)(t);if(r)throw Error("Ошибка при загрузке категорий: "+r);e&&e.result&&b(e.result)}catch(e){d(e.message),u("error")}finally{D(!1)}},loadProducts=async()=>{try{c(!0),d("");let e={};y&&(e.category_id=parseInt(y)),j&&(e.search=j);let{data:r,error:s}=await (0,l.jw)(t,e,1e3,0);if(s)throw Error("Ошибка при загрузке списка товаров: "+s);if(!r||!r.result||!r.result.items){p([]),d("Товары не найдены"),u("warning");return}let a=r.result.items.map(e=>e.product_id);if(0===a.length){p([]),d("Товары не найдены"),u("warning");return}let{data:i,error:o}=await (0,l.Cn)(t,a);if(o)throw Error("Ошибка при загрузке информации о товарах: "+o);let{data:n,error:x}=await (0,l.h_)(t,a);if(x)throw Error("Ошибка при загрузке информации об остатках: "+x);let{data:h,error:m}=await (0,l.o$)(t,a);if(m)throw Error("Ошибка при загрузке информации о ценах: "+m);let g=[];i&&i.result&&i.result.items&&i.result.items.forEach(e=>{let t=n?.result?.items?.find(t=>t.product_id===e.product_id),r=h?.result?.items?.find(t=>t.product_id===e.product_id);g.push({product_id:e.product_id,offer_id:e.offer_id||"",name:e.name||"Без названия",category:e.category||"Без категории",price:r?.price?.price||0,old_price:r?.price?.old_price,stock:t?.stocks?.reduce((e,t)=>e+t.present,0)||0,sku:e.sku||"",image_url:e.images?.[0]||"",status:e.status||"inactive"})}),p(g),0===g.length?(d("Товары не найдены"),u("warning")):(d(`Загружено ${g.length} товаров`),u("success"))}catch(e){d(e.message),u("error")}finally{c(!1)}},applyFilters=()=>{let e=[...x];if(y&&(e=e.filter(e=>e.category.toLowerCase().includes(y.toLowerCase()))),j){let t=j.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.sku.toLowerCase().includes(t)||e.offer_id.toLowerCase().includes(t))}"in-stock"===_?e=e.filter(e=>e.stock>0):"out-of-stock"===_&&(e=e.filter(e=>0===e.stock)),e.sort((e,t)=>"name"===N?"asc"===P?e.name.localeCompare(t.name):t.name.localeCompare(e.name):"price"===N?"asc"===P?e.price-t.price:t.price-e.price:"stock"===N?"asc"===P?e.stock-t.stock:t.stock-e.stock:0),m(e),E(Math.ceil(e.length/20)),q(1)},getCurrentPageProducts=()=>{let e=(C-1)*20,t=e+20;return h.slice(e,t)},handleProductSelect=e=>{let t=new Set(B);t.has(e)?t.delete(e):t.add(e),F(t)},saveSelectedProducts=async()=>{if(0===B.size){d("Не выбрано ни одного товара"),u("warning");return}try{c(!0);let t=x.filter(e=>B.has(e.product_id)),{error:r}=await i.OQ.from("exported_products").upsert(t.map(t=>({user_id:e,product_id:t.product_id,offer_id:t.offer_id,name:t.name,category:t.category,price:t.price,old_price:t.old_price||null,stock:t.stock,sku:t.sku,image_url:t.image_url||null,status:t.status,exported_at:new Date().toISOString()})));if(r)throw Error("Ошибка при сохранении товаров: "+r.message);d(`Успешно сохранено ${B.size} товаров`),u("success")}catch(e){d(e.message),u("error")}finally{c(!1)}},formatPrice=e=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:2}).format(e);return(0,s.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[s.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Выгрузка товаров"}),o&&s.jsx("div",{className:`p-4 mb-4 rounded ${"error"===n?"bg-red-100 text-red-700":"warning"===n?"bg-yellow-100 text-yellow-700":"bg-green-100 text-green-700"}`,children:o}),(0,s.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md mb-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Фильтры и поиск"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-gray-700 mb-2",children:"Категория"}),(0,s.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:y,onChange:e=>f(e.target.value),children:[s.jsx("option",{value:"",children:"Все категории"}),g.map(e=>s.jsx("option",{value:e.category_id,children:e.title},e.category_id))]})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-gray-700 mb-2",children:"Поиск по названию/SKU"}),s.jsx("input",{type:"text",className:"w-full px-3 py-2 border rounded-md",placeholder:"Введите название или SKU",value:j,onChange:e=>w(e.target.value)})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-gray-700 mb-2",children:"Наличие"}),(0,s.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:_,onChange:e=>v(e.target.value),children:[s.jsx("option",{value:"all",children:"Все товары"}),s.jsx("option",{value:"in-stock",children:"В наличии"}),s.jsx("option",{value:"out-of-stock",children:"Нет в наличии"})]})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-gray-700 mb-2",children:"Сортировка"}),(0,s.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:N,onChange:e=>k(e.target.value),children:[s.jsx("option",{value:"name",children:"По названию"}),s.jsx("option",{value:"price",children:"По цене"}),s.jsx("option",{value:"stock",children:"По остатку"})]})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-gray-700 mb-2",children:"Порядок"}),(0,s.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:P,onChange:e=>S(e.target.value),children:[s.jsx("option",{value:"asc",children:"По возрастанию"}),s.jsx("option",{value:"desc",children:"По убыванию"})]})]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("button",{onClick:loadProducts,className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",disabled:r,children:r?"Загрузка...":"Обновить товары"}),s.jsx("button",{onClick:saveSelectedProducts,className:"bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded",disabled:r||0===B.size,children:r?"Сохранение...":`Сохранить выбранные (${B.size})`})]})]}),(0,s.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h2",{className:"text-xl font-semibold",children:"Список товаров"}),(0,s.jsxs)("div",{className:"text-gray-600",children:["Всего: ",h.length," товаров"]})]}),h.length>0?(0,s.jsxs)(s.Fragment,{children:[s.jsx("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full bg-white",children:[s.jsx("thead",{children:(0,s.jsxs)("tr",{className:"bg-gray-100",children:[s.jsx("th",{className:"py-2 px-3 text-left",children:s.jsx("input",{type:"checkbox",checked:Z,onChange:()=>{let e=!Z;$(e);let t=new Set(B),r=getCurrentPageProducts();e?r.forEach(e=>{t.add(e.product_id)}):r.forEach(e=>{t.delete(e.product_id)}),F(t)}})}),s.jsx("th",{className:"py-2 px-3 text-left",children:"Фото"}),s.jsx("th",{className:"py-2 px-3 text-left",children:"Название"}),s.jsx("th",{className:"py-2 px-3 text-left",children:"SKU"}),s.jsx("th",{className:"py-2 px-3 text-left",children:"Категория"}),s.jsx("th",{className:"py-2 px-3 text-right",children:"Цена"}),s.jsx("th",{className:"py-2 px-3 text-right",children:"Остаток"}),s.jsx("th",{className:"py-2 px-3 text-center",children:"Статус"})]})}),s.jsx("tbody",{children:getCurrentPageProducts().map(e=>(0,s.jsxs)("tr",{className:"border-b hover:bg-gray-50",children:[s.jsx("td",{className:"py-2 px-3",children:s.jsx("input",{type:"checkbox",checked:B.has(e.product_id),onChange:()=>handleProductSelect(e.product_id)})}),s.jsx("td",{className:"py-2 px-3",children:e.image_url?s.jsx("img",{src:e.image_url,alt:e.name,className:"w-12 h-12 object-contain"}):s.jsx("div",{className:"w-12 h-12 bg-gray-200 flex items-center justify-center",children:s.jsx("span",{className:"text-gray-400 text-xs",children:"Нет фото"})})}),s.jsx("td",{className:"py-2 px-3",children:e.name}),s.jsx("td",{className:"py-2 px-3",children:e.sku}),s.jsx("td",{className:"py-2 px-3",children:e.category}),(0,s.jsxs)("td",{className:"py-2 px-3 text-right",children:[formatPrice(e.price),e.old_price&&s.jsx("div",{className:"text-gray-400 line-through text-xs",children:formatPrice(e.old_price)})]}),s.jsx("td",{className:"py-2 px-3 text-right",children:s.jsx("span",{className:e.stock>0?"text-green-600":"text-red-600",children:e.stock})}),s.jsx("td",{className:"py-2 px-3 text-center",children:s.jsx("span",{className:`px-2 py-1 rounded text-xs ${"active"===e.status?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:"active"===e.status?"Активен":"Неактивен"})})]},e.product_id))})]})}),O>1&&s.jsx("div",{className:"flex justify-center mt-6",children:(0,s.jsxs)("nav",{className:"flex items-center",children:[s.jsx("button",{onClick:()=>q(e=>Math.max(e-1,1)),disabled:1===C,className:"px-3 py-1 rounded-l border bg-white disabled:opacity-50",children:"\xab"}),Array.from({length:O},(e,t)=>t+1).map(e=>s.jsx("button",{onClick:()=>q(e),className:`px-3 py-1 border-t border-b ${C===e?"bg-blue-500 text-white":"bg-white"}`,children:e},e)),s.jsx("button",{onClick:()=>q(e=>Math.min(e+1,O)),disabled:C===O,className:"px-3 py-1 rounded-r border bg-white disabled:opacity-50",children:"\xbb"})]})})]}):s.jsx("div",{className:"text-center py-8 text-gray-500",children:r?s.jsx("div",{className:"flex justify-center items-center",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):"Нет товаров для отображения"})]})]})},page=()=>{let[e,t]=(0,a.useState)(null),[r,l]=(0,a.useState)(null),[c,o]=(0,a.useState)(!0),[d,n]=(0,a.useState)(null);return((0,a.useEffect)(()=>{let checkAuth=async()=>{try{o(!0);let{data:{user:e},error:r}=await i.OQ.auth.getUser();if(r)throw Error("Ошибка авторизации: "+r.message);if(!e)throw Error("Необходимо авторизоваться");t(e.id);let{data:s,error:a}=await i.OQ.from("ozon_credentials").select("*").eq("user_id",e.id).eq("is_active",!0).single();if(a&&"PGRST116"!==a.code)throw Error("Ошибка при получении учетных данных: "+a.message);if(!s)throw Error("Необходимо добавить учетные данные OZON");l({clientId:s.client_id,apiKey:s.api_key})}catch(e){n(e.message)}finally{o(!1)}};checkAuth()},[]),c)?s.jsx("div",{className:"flex justify-center items-center min-h-screen",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):d?(0,s.jsxs)("div",{className:"max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md",children:[s.jsx("div",{className:"text-red-500 mb-4",children:d}),s.jsx("button",{onClick:()=>window.location.href="/",className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",children:"Вернуться на главную"})]}):s.jsx("div",{className:"container mx-auto px-4 py-8",children:e&&r&&s.jsx(components_ProductExportPage,{userId:e,credentials:r})})}},4302:(e,t,r)=>{"use strict";r.r(t),r.d(t,{$$typeof:()=>i,__esModule:()=>l,default:()=>o});var s=r(5153);let a=(0,s.createProxy)(String.raw`F:\00. Проекты веб дизайна и другое\OZOBID\OZOBID-Railway\src\app\products\page.tsx`),{__esModule:l,$$typeof:i}=a,c=a.default,o=c}};var t=require("../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[472,287,155,863],()=>__webpack_exec__(8832));module.exports=r})();