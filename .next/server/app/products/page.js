(()=>{var e={};e.id=286,e.ids=[286],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},4300:e=>{"use strict";e.exports=require("buffer")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3849:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},2956:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>l.a,__next_app__:()=>x,originalPathname:()=>u,pages:()=>d,routeModule:()=>p,tree:()=>n});var r=s(482),a=s(9108),i=s(2563),l=s.n(i),c=s(8300),o={};for(let e in c)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>c[e]);s.d(t,o);let n=["",{children:["products",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,9645)),"C:\\temp_ozobid\\src\\app\\products\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,1342)),"C:\\temp_ozobid\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,9361,23)),"next/dist/client/components/not-found-error"]}],d=["C:\\temp_ozobid\\src\\app\\products\\page.tsx"],u="/products/page",x={require:s,loadChunk:()=>Promise.resolve()},p=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/products/page",pathname:"/products",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:n}})},9906:(e,t,s)=>{Promise.resolve().then(s.bind(s,6266))},6266:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>o});var r=s(5344),a=s(3729),i=s(6804),l=s(8704);let c=({userId:e,credentials:t})=>{let[s,c]=(0,a.useState)(!1),[o,n]=(0,a.useState)(""),[d,u]=(0,a.useState)("success"),[x,p]=(0,a.useState)([]),[m,h]=(0,a.useState)([]),[g,b]=(0,a.useState)([]),[y,f]=(0,a.useState)(""),[j,w]=(0,a.useState)(""),[v,N]=(0,a.useState)("all"),[_,k]=(0,a.useState)("name"),[q,S]=(0,a.useState)("asc"),[C,E]=(0,a.useState)(1),[P,z]=(0,a.useState)(1),[$,M]=(0,a.useState)(!1),[O,L]=(0,a.useState)(new Set),[U,A]=(0,a.useState)(!1);(0,a.useEffect)(()=>{G(),I()},[e,t]),(0,a.useEffect)(()=>{K()},[x,y,j,v,_,q]);let G=async()=>{try{M(!0);let{data:e,error:s}=await (0,i.CP)(t);if(s)throw Error("Ошибка при загрузке категорий: "+s);e&&e.result&&b(e.result)}catch(e){n(e.message),u("error")}finally{M(!1)}},I=async()=>{try{c(!0),n("");let e={};y&&(e.category_id=parseInt(y)),j&&(e.search=j);let{data:s,error:r}=await (0,i.jw)(t,e,1e3,0);if(r)throw Error("Ошибка при загрузке списка товаров: "+r);if(!s||!s.result||!s.result.items){p([]),n("Товары не найдены"),u("warning");return}let a=s.result.items.map(e=>e.product_id);if(0===a.length){p([]),n("Товары не найдены"),u("warning");return}let{data:l,error:o}=await (0,i.Cn)(t,a);if(o)throw Error("Ошибка при загрузке информации о товарах: "+o);let{data:d,error:x}=await (0,i.h_)(t,a);if(x)throw Error("Ошибка при загрузке информации об остатках: "+x);let{data:m,error:h}=await (0,i.o$)(t,a);if(h)throw Error("Ошибка при загрузке информации о ценах: "+h);let g=[];l&&l.result&&l.result.items&&l.result.items.forEach(e=>{let t=d?.result?.items?.find(t=>t.product_id===e.product_id),s=m?.result?.items?.find(t=>t.product_id===e.product_id);g.push({product_id:e.product_id,offer_id:e.offer_id||"",name:e.name||"Без названия",category:e.category||"Без категории",price:s?.price?.price||0,old_price:s?.price?.old_price,stock:t?.stocks?.reduce((e,t)=>e+t.present,0)||0,sku:e.sku||"",image_url:e.images?.[0]||"",status:e.status||"inactive"})}),p(g),0===g.length?(n("Товары не найдены"),u("warning")):(n(`Загружено ${g.length} товаров`),u("success"))}catch(e){n(e.message),u("error")}finally{c(!1)}},K=()=>{let e=[...x];if(y&&(e=e.filter(e=>e.category.toLowerCase().includes(y.toLowerCase()))),j){let t=j.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.sku.toLowerCase().includes(t)||e.offer_id.toLowerCase().includes(t))}"in-stock"===v?e=e.filter(e=>e.stock>0):"out-of-stock"===v&&(e=e.filter(e=>0===e.stock)),e.sort((e,t)=>"name"===_?"asc"===q?e.name.localeCompare(t.name):t.name.localeCompare(e.name):"price"===_?"asc"===q?e.price-t.price:t.price-e.price:"stock"===_?"asc"===q?e.stock-t.stock:t.stock-e.stock:0),h(e),z(Math.ceil(e.length/20)),E(1)},R=()=>{let e=(C-1)*20;return m.slice(e,e+20)},F=e=>{let t=new Set(O);t.has(e)?t.delete(e):t.add(e),L(t)},Q=async()=>{if(0===O.size){n("Не выбрано ни одного товара"),u("warning");return}try{c(!0);let t=x.filter(e=>O.has(e.product_id)),{error:s}=await l.OQ.from("exported_products").upsert(t.map(t=>({user_id:e,product_id:t.product_id,offer_id:t.offer_id,name:t.name,category:t.category,price:t.price,old_price:t.old_price||null,stock:t.stock,sku:t.sku,image_url:t.image_url||null,status:t.status,exported_at:new Date().toISOString()})));if(s)throw Error("Ошибка при сохранении товаров: "+s.message);n(`Успешно сохранено ${O.size} товаров`),u("success")}catch(e){n(e.message),u("error")}finally{c(!1)}},D=e=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",minimumFractionDigits:2}).format(e);return(0,r.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[r.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Выгрузка товаров"}),o&&r.jsx("div",{className:`p-4 mb-4 rounded ${"error"===d?"bg-red-100 text-red-700":"warning"===d?"bg-yellow-100 text-yellow-700":"bg-green-100 text-green-700"}`,children:o}),(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md mb-6",children:[r.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Фильтры и поиск"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Категория"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:y,onChange:e=>f(e.target.value),children:[r.jsx("option",{value:"",children:"Все категории"}),g.map(e=>r.jsx("option",{value:e.category_id,children:e.title},e.category_id))]})]}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Поиск по названию/SKU"}),r.jsx("input",{type:"text",className:"w-full px-3 py-2 border rounded-md",placeholder:"Введите название или SKU",value:j,onChange:e=>w(e.target.value)})]}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Наличие"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:v,onChange:e=>N(e.target.value),children:[r.jsx("option",{value:"all",children:"Все товары"}),r.jsx("option",{value:"in-stock",children:"В наличии"}),r.jsx("option",{value:"out-of-stock",children:"Нет в наличии"})]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Сортировка"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:_,onChange:e=>k(e.target.value),children:[r.jsx("option",{value:"name",children:"По названию"}),r.jsx("option",{value:"price",children:"По цене"}),r.jsx("option",{value:"stock",children:"По остатку"})]})]}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Порядок"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",value:q,onChange:e=>S(e.target.value),children:[r.jsx("option",{value:"asc",children:"По возрастанию"}),r.jsx("option",{value:"desc",children:"По убыванию"})]})]})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[r.jsx("button",{onClick:I,className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",disabled:s,children:s?"Загрузка...":"Обновить товары"}),r.jsx("button",{onClick:Q,className:"bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded",disabled:s||0===O.size,children:s?"Сохранение...":`Сохранить выбранные (${O.size})`})]})]}),(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h2",{className:"text-xl font-semibold",children:"Список товаров"}),(0,r.jsxs)("div",{className:"text-gray-600",children:["Всего: ",m.length," товаров"]})]}),m.length>0?(0,r.jsxs)(r.Fragment,{children:[r.jsx("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"min-w-full bg-white",children:[r.jsx("thead",{children:(0,r.jsxs)("tr",{className:"bg-gray-100",children:[r.jsx("th",{className:"py-2 px-3 text-left",children:r.jsx("input",{type:"checkbox",checked:U,onChange:()=>{let e=!U;A(e);let t=new Set(O),s=R();e?s.forEach(e=>{t.add(e.product_id)}):s.forEach(e=>{t.delete(e.product_id)}),L(t)}})}),r.jsx("th",{className:"py-2 px-3 text-left",children:"Фото"}),r.jsx("th",{className:"py-2 px-3 text-left",children:"Название"}),r.jsx("th",{className:"py-2 px-3 text-left",children:"SKU"}),r.jsx("th",{className:"py-2 px-3 text-left",children:"Категория"}),r.jsx("th",{className:"py-2 px-3 text-right",children:"Цена"}),r.jsx("th",{className:"py-2 px-3 text-right",children:"Остаток"}),r.jsx("th",{className:"py-2 px-3 text-center",children:"Статус"})]})}),r.jsx("tbody",{children:R().map(e=>(0,r.jsxs)("tr",{className:"border-b hover:bg-gray-50",children:[r.jsx("td",{className:"py-2 px-3",children:r.jsx("input",{type:"checkbox",checked:O.has(e.product_id),onChange:()=>F(e.product_id)})}),r.jsx("td",{className:"py-2 px-3",children:e.image_url?r.jsx("img",{src:e.image_url,alt:e.name,className:"w-12 h-12 object-contain"}):r.jsx("div",{className:"w-12 h-12 bg-gray-200 flex items-center justify-center",children:r.jsx("span",{className:"text-gray-400 text-xs",children:"Нет фото"})})}),r.jsx("td",{className:"py-2 px-3",children:e.name}),r.jsx("td",{className:"py-2 px-3",children:e.sku}),r.jsx("td",{className:"py-2 px-3",children:e.category}),(0,r.jsxs)("td",{className:"py-2 px-3 text-right",children:[D(e.price),e.old_price&&r.jsx("div",{className:"text-gray-400 line-through text-xs",children:D(e.old_price)})]}),r.jsx("td",{className:"py-2 px-3 text-right",children:r.jsx("span",{className:e.stock>0?"text-green-600":"text-red-600",children:e.stock})}),r.jsx("td",{className:"py-2 px-3 text-center",children:r.jsx("span",{className:`px-2 py-1 rounded text-xs ${"active"===e.status?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:"active"===e.status?"Активен":"Неактивен"})})]},e.product_id))})]})}),P>1&&r.jsx("div",{className:"flex justify-center mt-6",children:(0,r.jsxs)("nav",{className:"flex items-center",children:[r.jsx("button",{onClick:()=>E(e=>Math.max(e-1,1)),disabled:1===C,className:"px-3 py-1 rounded-l border bg-white disabled:opacity-50",children:"\xab"}),Array.from({length:P},(e,t)=>t+1).map(e=>r.jsx("button",{onClick:()=>E(e),className:`px-3 py-1 border-t border-b ${C===e?"bg-blue-500 text-white":"bg-white"}`,children:e},e)),r.jsx("button",{onClick:()=>E(e=>Math.min(e+1,P)),disabled:C===P,className:"px-3 py-1 rounded-r border bg-white disabled:opacity-50",children:"\xbb"})]})})]}):r.jsx("div",{className:"text-center py-8 text-gray-500",children:s?r.jsx("div",{className:"flex justify-center items-center",children:r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):"Нет товаров для отображения"})]})]})},o=()=>{let[e,t]=(0,a.useState)(null),[s,i]=(0,a.useState)(null),[o,n]=(0,a.useState)(!0),[d,u]=(0,a.useState)(null);return((0,a.useEffect)(()=>{(async()=>{try{n(!0);let{data:{user:e},error:s}=await l.OQ.auth.getUser();if(s)throw Error("Ошибка авторизации: "+s.message);if(!e)throw Error("Необходимо авторизоваться");t(e.id);let{data:r,error:a}=await l.OQ.from("ozon_credentials").select("*").eq("user_id",e.id).eq("is_active",!0).single();if(a&&"PGRST116"!==a.code)throw Error("Ошибка при получении учетных данных: "+a.message);if(!r)throw Error("Необходимо добавить учетные данные OZON");i({clientId:r.client_id,apiKey:r.api_key})}catch(e){u(e.message)}finally{n(!1)}})()},[]),o)?r.jsx("div",{className:"flex justify-center items-center min-h-screen",children:r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):d?(0,r.jsxs)("div",{className:"max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md",children:[r.jsx("div",{className:"text-red-500 mb-4",children:d}),r.jsx("button",{onClick:()=>window.location.href="/",className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",children:"Вернуться на главную"})]}):r.jsx("div",{className:"container mx-auto px-4 py-8",children:e&&s&&r.jsx(c,{userId:e,credentials:s})})}},9645:(e,t,s)=>{"use strict";s.r(t),s.d(t,{$$typeof:()=>i,__esModule:()=>a,default:()=>l});let r=(0,s(6843).createProxy)(String.raw`C:\temp_ozobid\src\app\products\page.tsx`),{__esModule:a,$$typeof:i}=r,l=r.default}};var t=require("../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[22,516,18],()=>s(2956));module.exports=r})();