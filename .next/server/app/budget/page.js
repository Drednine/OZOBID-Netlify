(()=>{var e={};e.id=942,e.ids=[942],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1630:e=>{"use strict";e.exports=require("http")},1645:e=>{"use strict";e.exports=require("net")},1820:e=>{"use strict";e.exports=require("os")},1933:(e,t,r)=>{Promise.resolve().then(r.bind(r,2226))},1997:e=>{"use strict";e.exports=require("punycode")},2226:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>s});let s=(0,r(2907).registerClientReference)(function(){throw Error("Attempted to call the default export of \"F:\\\\00. Проекты веб дизайна и другое\\\\OZOBID\\\\OZOBID-Railway\\\\src\\\\app\\\\budget\\\\page.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\budget\\page.tsx","default")},2412:e=>{"use strict";e.exports=require("assert")},2998:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>c});var s=r(687),i=r(3210),a=r(7605),l=r(3161),d=r(6391);let n=({userId:e,storeId:t,credentials:r,performanceCredentials:a,dailyLimit:n,warningThreshold:o,autoDisable:c,onBudgetExceeded:u})=>{let[m,x]=(0,i.useState)(0),[p,h]=(0,i.useState)(0),[b,g]=(0,i.useState)(!1),[f,y]=(0,i.useState)(!1),[v,j]=(0,i.useState)(!1),[_,w]=(0,i.useState)(null),[N,q]=(0,i.useState)(null),O=async()=>{j(!0),q(null);try{let{data:s,error:i}=await d.ND.from("budget_monitoring").select("*").eq("user_id",e).eq("store_id",t).single();if(i)throw Error(i.message);if(c){let{data:i,error:m}=await (0,l.OA)(r,a,n,c);if(m)throw Error(m);if(i){let r=i.overBudgetCampaigns.length>0,a=new Date().toISOString();x(s?.total_spent||0),h((s?.total_spent||0)/n*100),g((s?.total_spent||0)>=n*o/100),y(r),w(a),r&&u&&u(),await d.ND.from("budget_monitoring").upsert({user_id:e,store_id:t,total_spent:s?.total_spent||0,budget_exceeded:r,last_checked:a})}}else s&&(x(s.total_spent||0),h((s.total_spent||0)/n*100),g((s.total_spent||0)>=n*o/100),y(s.budget_exceeded||!1),w(s.last_checked))}catch(e){q(`Ошибка при проверке бюджета: ${e.message}`)}finally{j(!1)}};return(0,i.useEffect)(()=>{O();let e=setInterval(O,18e5);return()=>clearInterval(e)},[e,t,n,o,c]),(0,s.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"Мониторинг дневного бюджета"}),N&&(0,s.jsx)("div",{className:"p-4 mb-4 rounded bg-red-100 text-red-700",children:N}),(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsxs)("div",{className:"flex justify-between mb-2",children:[(0,s.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["Потрачено: ",m.toFixed(2)," ₽ из ",n.toFixed(2)," ₽"]}),(0,s.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:[p.toFixed(1),"%"]})]}),(0,s.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:(0,s.jsx)("div",{className:`h-2.5 rounded-full ${f?"bg-red-600":b?"bg-yellow-500":"bg-green-600"}`,style:{width:`${Math.min(p,100)}%`}})})]}),(0,s.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-center mb-4",children:[(0,s.jsx)("div",{className:"mb-4 md:mb-0",children:(0,s.jsx)("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${f?"bg-red-100 text-red-800":b?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:f?"Бюджет превышен":b?"Приближается к лимиту":"В пределах бюджета"})}),(0,s.jsx)("div",{className:"text-sm text-gray-500",children:_&&`Последняя проверка: ${new Date(_).toLocaleString()}`})]}),(0,s.jsx)("button",{onClick:O,disabled:v,className:"w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 disabled:opacity-50",children:v?"Проверка...":"Проверить сейчас"})]})},o=({userId:e,credentials:t})=>{let[r,o]=(0,i.useState)([]),[c,u]=(0,i.useState)(!1),[m,x]=(0,i.useState)(""),[p,h]=(0,i.useState)(null),[b,g]=(0,i.useState)(!1),[f,y]=(0,i.useState)("default"),[v,j]=(0,i.useState)({clientId:t.clientId,apiKey:t.apiKey}),{register:_,handleSubmit:w,setValue:N,watch:q,formState:{errors:O}}=(0,a.mN)(),S=q("isActive"),I=q("dailyLimit")||0,k=q("notificationThreshold")||80;(0,i.useEffect)(()=>{(async()=>{u(!0);let{data:r,error:s}=await (0,l.Ct)(t);s?x("Ошибка при загрузке кампаний: "+s.message):r&&o(r.campaigns||[]);let{data:i,error:a}=await (0,d.$K)(e);a?x("Ошибка при загрузке настроек бюджета: "+a.message):i&&(N("dailyLimit",i.daily_limit||0),N("notificationThreshold",i.notification_threshold||80),N("isActive",void 0===i.is_active||i.is_active),i.store_id&&y(i.store_id),i.performance_client_id&&i.performance_api_key&&j({clientId:i.performance_client_id,apiKey:i.performance_api_key})),u(!1)})()},[e,t,N]);let D=e=>{h(e);let t=r.find(t=>t.id===e);t&&N("campaignBudget",t.dailyBudget||0)},B=async r=>{u(!0),x("");try{let{error:s}=await (0,d.Mx)(e,{daily_limit:r.dailyLimit,notification_threshold:r.notificationThreshold,is_active:r.isActive,store_id:f,performance_client_id:v.clientId,performance_api_key:v.apiKey});if(s)throw Error("Ошибка при обновлении настроек бюджета: "+s.message);if(p){let{error:e}=await (0,l.D4)(t,p,r.campaignBudget);if(e)throw Error("Ошибка при обновлении бюджета кампании: "+e.message)}x("Настройки бюджета успешно обновлены")}catch(e){x(e.message)}finally{u(!1)}};return(0,s.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-6",children:"Настройки бюджета"}),m&&(0,s.jsx)("div",{className:`p-4 mb-4 rounded ${m.includes("Ошибка")?"bg-red-100 text-red-700":"bg-green-100 text-green-700"}`,children:m}),(0,s.jsxs)("form",{onSubmit:w(B),children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-gray-700 mb-2",children:"Общий дневной лимит (руб.)"}),(0,s.jsx)("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",..._("dailyLimit",{required:"Это поле обязательно",min:{value:0,message:"Значение должно быть положительным"}})}),O.dailyLimit&&(0,s.jsx)("p",{className:"text-red-500 mt-1",children:O.dailyLimit.message})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-gray-700 mb-2",children:"Порог уведомления (%)"}),(0,s.jsx)("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",..._("notificationThreshold",{required:"Это поле обязательно",min:{value:1,message:"Минимальное значение 1%"},max:{value:100,message:"Максимальное значение 100%"}})}),O.notificationThreshold&&(0,s.jsx)("p",{className:"text-red-500 mt-1",children:O.notificationThreshold.message})]}),(0,s.jsx)("div",{className:"mb-4",children:(0,s.jsxs)("label",{className:"flex items-center text-gray-700 mb-2",children:[(0,s.jsx)("input",{type:"checkbox",className:"mr-2",..._("isActive")}),"Автоматически отключать кампании при превышении лимита"]})}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-gray-700 mb-2",children:"Выберите кампанию для настройки бюджета"}),(0,s.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",onChange:e=>D(e.target.value),defaultValue:"",children:[(0,s.jsx)("option",{value:"",disabled:!0,children:"Выберите кампанию"}),r.map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.name," (","active"===e.state?"активна":"приостановлена",")"]},e.id))]})]}),p&&(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block text-gray-700 mb-2",children:"Дневной бюджет кампании (руб.)"}),(0,s.jsx)("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",..._("campaignBudget",{required:"Это поле обязательно",min:{value:0,message:"Значение должно быть положительным"}})}),O.campaignBudget&&(0,s.jsx)("p",{className:"text-red-500 mt-1",children:O.campaignBudget.message})]}),(0,s.jsx)("button",{type:"submit",className:"w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md",disabled:c,children:c?"Сохранение...":"Сохранить настройки"}),(0,s.jsx)("button",{type:"button",className:"w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md",onClick:()=>g(!b),children:b?"Скрыть мониторинг":"Показать мониторинг"})]})]}),b&&(0,s.jsx)("div",{children:(0,s.jsx)(n,{userId:e,storeId:f,credentials:t,performanceCredentials:v,dailyLimit:I,warningThreshold:k,autoDisable:S})})]})})},c=()=>{let[e,t]=(0,i.useState)(null),[r,a]=(0,i.useState)(null),[l,n]=(0,i.useState)(!0),[c,u]=(0,i.useState)(null);return((0,i.useEffect)(()=>{(async()=>{try{n(!0);let{data:{user:e},error:r}=await d.ND.auth.getUser();if(r)throw Error("Ошибка авторизации: "+r.message);if(!e)throw Error("Необходимо авторизоваться");t(e.id);let{data:s,error:i}=await d.ND.from("ozon_credentials").select("*").eq("user_id",e.id).eq("is_active",!0).single();if(i&&"PGRST116"!==i.code)throw Error("Ошибка при получении учетных данных: "+i.message);if(!s)throw Error("Необходимо добавить учетные данные OZON");a({clientId:s.client_id,apiKey:s.api_key})}catch(e){u(e.message)}finally{n(!1)}})()},[]),l)?(0,s.jsx)("div",{className:"flex justify-center items-center min-h-screen",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):c?(0,s.jsxs)("div",{className:"max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md",children:[(0,s.jsx)("div",{className:"text-red-500 mb-4",children:c}),(0,s.jsx)("button",{onClick:()=>window.location.href="/",className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",children:"Вернуться на главную"})]}):(0,s.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-8",children:"Управление бюджетом"}),e&&r&&(0,s.jsx)(o,{userId:e,credentials:r})]})}},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:e=>{"use strict";e.exports=require("path")},3997:e=>{"use strict";e.exports=require("tty")},4075:e=>{"use strict";e.exports=require("zlib")},4631:e=>{"use strict";e.exports=require("tls")},4735:e=>{"use strict";e.exports=require("events")},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},5901:(e,t,r)=>{Promise.resolve().then(r.bind(r,2998))},6913:(e,t,r)=>{"use strict";r.r(t),r.d(t,{GlobalError:()=>l.a,__next_app__:()=>u,pages:()=>c,routeModule:()=>m,tree:()=>o});var s=r(5239),i=r(8088),a=r(8170),l=r.n(a),d=r(893),n={};for(let e in d)0>["default","tree","pages","GlobalError","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>d[e]);r.d(t,n);let o={children:["",{children:["budget",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,2226)),"F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\budget\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,4431)),"F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,7398,23)),"next/dist/client/components/not-found-error"],forbidden:[()=>Promise.resolve().then(r.t.bind(r,9999,23)),"next/dist/client/components/forbidden-error"],unauthorized:[()=>Promise.resolve().then(r.t.bind(r,5284,23)),"next/dist/client/components/unauthorized-error"]}]}.children,c=["F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\budget\\page.tsx"],u={require:r,loadChunk:()=>Promise.resolve()},m=new s.AppPageRouteModule({definition:{kind:i.RouteKind.APP_PAGE,page:"/budget/page",pathname:"/budget",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},7910:e=>{"use strict";e.exports=require("stream")},8354:e=>{"use strict";e.exports=require("util")},9021:e=>{"use strict";e.exports=require("fs")},9121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},9551:e=>{"use strict";e.exports=require("url")}};var t=require("../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[825,414,605,497],()=>r(6913));module.exports=s})();