(()=>{var e={};e.id=379,e.ids=[379],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},4300:e=>{"use strict";e.exports=require("buffer")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3849:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},4448:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>l.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>c,routeModule:()=>x,tree:()=>o});var r=s(482),i=s(9108),a=s(2563),l=s.n(a),n=s(8300),d={};for(let e in n)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>n[e]);s.d(t,d);let o=["",{children:["budget",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,2709)),"C:\\temp_ozobid\\src\\app\\budget\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,1342)),"C:\\temp_ozobid\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,9361,23)),"next/dist/client/components/not-found-error"]}],c=["C:\\temp_ozobid\\src\\app\\budget\\page.tsx"],u="/budget/page",m={require:s,loadChunk:()=>Promise.resolve()},x=new r.AppPageRouteModule({definition:{kind:i.x.APP_PAGE,page:"/budget/page",pathname:"/budget",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},2821:(e,t,s)=>{Promise.resolve().then(s.bind(s,9202))},9202:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var r=s(5344),i=s(3729),a=s(708),l=s(6804),n=s(8704);let d=({userId:e,storeId:t,credentials:s,performanceCredentials:a,dailyLimit:d,warningThreshold:o,autoDisable:c,onBudgetExceeded:u})=>{let[m,x]=(0,i.useState)(0),[p,g]=(0,i.useState)(0),[h,b]=(0,i.useState)(!1),[f,y]=(0,i.useState)(!1),[_,j]=(0,i.useState)(!1),[v,w]=(0,i.useState)(null),[N,q]=(0,i.useState)(null),S=async()=>{j(!0),q(null);try{let{data:r,error:i}=await n.OQ.from("budget_monitoring").select("*").eq("user_id",e).eq("store_id",t).single();if(i)throw Error(i.message);if(c){let{data:i,error:m}=await (0,l.aj)(s,a,d,c);if(m)throw Error(m);if(i){let s=i.overBudgetCampaigns.length>0,a=new Date().toISOString();x(r?.total_spent||0),g((r?.total_spent||0)/d*100),b((r?.total_spent||0)>=d*o/100),y(s),w(a),s&&u&&u(),await n.OQ.from("budget_monitoring").upsert({user_id:e,store_id:t,total_spent:r?.total_spent||0,budget_exceeded:s,last_checked:a})}}else r&&(x(r.total_spent||0),g((r.total_spent||0)/d*100),b((r.total_spent||0)>=d*o/100),y(r.budget_exceeded||!1),w(r.last_checked))}catch(e){q(`Ошибка при проверке бюджета: ${e.message}`)}finally{j(!1)}};return(0,i.useEffect)(()=>{S();let e=setInterval(S,18e5);return()=>clearInterval(e)},[e,t,d,o,c]),(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[r.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Мониторинг дневного бюджета"}),N&&r.jsx("div",{className:"p-4 mb-4 rounded bg-red-100 text-red-700",children:N}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("div",{className:"flex justify-between mb-2",children:[(0,r.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["Потрачено: ",m.toFixed(2)," ₽ из ",d.toFixed(2)," ₽"]}),(0,r.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:[p.toFixed(1),"%"]})]}),r.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:r.jsx("div",{className:`h-2.5 rounded-full ${f?"bg-red-600":h?"bg-yellow-500":"bg-green-600"}`,style:{width:`${Math.min(p,100)}%`}})})]}),(0,r.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-center mb-4",children:[r.jsx("div",{className:"mb-4 md:mb-0",children:r.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${f?"bg-red-100 text-red-800":h?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:f?"Бюджет превышен":h?"Приближается к лимиту":"В пределах бюджета"})}),r.jsx("div",{className:"text-sm text-gray-500",children:v&&`Последняя проверка: ${new Date(v).toLocaleString()}`})]}),r.jsx("button",{onClick:S,disabled:_,className:"w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 disabled:opacity-50",children:_?"Проверка...":"Проверить сейчас"})]})},o=({userId:e,credentials:t})=>{let[s,o]=(0,i.useState)([]),[c,u]=(0,i.useState)(!1),[m,x]=(0,i.useState)(""),[p,g]=(0,i.useState)(null),[h,b]=(0,i.useState)(!1),[f,y]=(0,i.useState)("default"),[_,j]=(0,i.useState)({clientId:t.clientId,apiKey:t.apiKey}),{register:v,handleSubmit:w,setValue:N,watch:q,formState:{errors:S}}=(0,a.cI)(),k=q("isActive"),P=q("dailyLimit")||0,E=q("notificationThreshold")||80;(0,i.useEffect)(()=>{(async()=>{u(!0);let{data:s,error:r}=await (0,l.x)(t);r?x("Ошибка при загрузке кампаний: "+r.message):s&&o(s.campaigns||[]);let{data:i,error:a}=await (0,n.m1)(e);a?x("Ошибка при загрузке настроек бюджета: "+a.message):i&&(N("dailyLimit",i.daily_limit||0),N("notificationThreshold",i.notification_threshold||80),N("isActive",void 0===i.is_active||i.is_active),i.store_id&&y(i.store_id),i.performance_client_id&&i.performance_api_key&&j({clientId:i.performance_client_id,apiKey:i.performance_api_key})),u(!1)})()},[e,t,N]);let C=e=>{g(e);let t=s.find(t=>t.id===e);t&&N("campaignBudget",t.dailyBudget||0)},I=async s=>{u(!0),x("");try{let{error:r}=await (0,n.rO)(e,{daily_limit:s.dailyLimit,notification_threshold:s.notificationThreshold,is_active:s.isActive,store_id:f,performance_client_id:_.clientId,performance_api_key:_.apiKey});if(r)throw Error("Ошибка при обновлении настроек бюджета: "+r.message);if(p){let{error:e}=await (0,l.kC)(t,p,s.campaignBudget);if(e)throw Error("Ошибка при обновлении бюджета кампании: "+e.message)}x("Настройки бюджета успешно обновлены")}catch(e){x(e.message)}finally{u(!1)}};return r.jsx("div",{className:"max-w-4xl mx-auto",children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[r.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Настройки бюджета"}),m&&r.jsx("div",{className:`p-4 mb-4 rounded ${m.includes("Ошибка")?"bg-red-100 text-red-700":"bg-green-100 text-green-700"}`,children:m}),(0,r.jsxs)("form",{onSubmit:w(I),children:[(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Общий дневной лимит (руб.)"}),r.jsx("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",...v("dailyLimit",{required:"Это поле обязательно",min:{value:0,message:"Значение должно быть положительным"}})}),S.dailyLimit&&r.jsx("p",{className:"text-red-500 mt-1",children:S.dailyLimit.message})]}),(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Порог уведомления (%)"}),r.jsx("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",...v("notificationThreshold",{required:"Это поле обязательно",min:{value:1,message:"Минимальное значение 1%"},max:{value:100,message:"Максимальное значение 100%"}})}),S.notificationThreshold&&r.jsx("p",{className:"text-red-500 mt-1",children:S.notificationThreshold.message})]}),r.jsx("div",{className:"mb-4",children:(0,r.jsxs)("label",{className:"flex items-center text-gray-700 mb-2",children:[r.jsx("input",{type:"checkbox",className:"mr-2",...v("isActive")}),"Автоматически отключать кампании при превышении лимита"]})}),(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Выберите кампанию для настройки бюджета"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",onChange:e=>C(e.target.value),defaultValue:"",children:[r.jsx("option",{value:"",disabled:!0,children:"Выберите кампанию"}),s.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.name," (","active"===e.state?"активна":"приостановлена",")"]},e.id))]})]}),p&&(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Дневной бюджет кампании (руб.)"}),r.jsx("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",...v("campaignBudget",{required:"Это поле обязательно",min:{value:0,message:"Значение должно быть положительным"}})}),S.campaignBudget&&r.jsx("p",{className:"text-red-500 mt-1",children:S.campaignBudget.message})]}),r.jsx("button",{type:"submit",className:"w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md",disabled:c,children:c?"Сохранение...":"Сохранить настройки"}),r.jsx("button",{type:"button",className:"w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md",onClick:()=>b(!h),children:h?"Скрыть мониторинг":"Показать мониторинг"})]})]}),h&&r.jsx("div",{children:r.jsx(d,{userId:e,storeId:f,credentials:t,performanceCredentials:_,dailyLimit:P,warningThreshold:E,autoDisable:k})})]})})},c=()=>{let[e,t]=(0,i.useState)(null),[s,a]=(0,i.useState)(null),[l,d]=(0,i.useState)(!0),[c,u]=(0,i.useState)(null);return((0,i.useEffect)(()=>{(async()=>{try{d(!0);let{data:{user:e},error:s}=await n.OQ.auth.getUser();if(s)throw Error("Ошибка авторизации: "+s.message);if(!e)throw Error("Необходимо авторизоваться");t(e.id);let{data:r,error:i}=await n.OQ.from("ozon_credentials").select("*").eq("user_id",e.id).eq("is_active",!0).single();if(i&&"PGRST116"!==i.code)throw Error("Ошибка при получении учетных данных: "+i.message);if(!r)throw Error("Необходимо добавить учетные данные OZON");a({clientId:r.client_id,apiKey:r.api_key})}catch(e){u(e.message)}finally{d(!1)}})()},[]),l)?r.jsx("div",{className:"flex justify-center items-center min-h-screen",children:r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):c?(0,r.jsxs)("div",{className:"max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md",children:[r.jsx("div",{className:"text-red-500 mb-4",children:c}),r.jsx("button",{onClick:()=>window.location.href="/",className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",children:"Вернуться на главную"})]}):(0,r.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[r.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Управление бюджетом"}),e&&s&&r.jsx(o,{userId:e,credentials:s})]})}},2709:(e,t,s)=>{"use strict";s.r(t),s.d(t,{$$typeof:()=>a,__esModule:()=>i,default:()=>l});let r=(0,s(6843).createProxy)(String.raw`C:\temp_ozobid\src\app\budget\page.tsx`),{__esModule:i,$$typeof:a}=r,l=r.default}};var t=require("../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[22,516,708,18],()=>s(4448));module.exports=r})();