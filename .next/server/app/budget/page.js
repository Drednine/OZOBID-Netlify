(()=>{var e={};e.id=379,e.ids=[379],e.modules={5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},5528:e=>{"use strict";e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},1877:e=>{"use strict";e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},5319:e=>{"use strict";e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},9491:e=>{"use strict";e.exports=require("assert")},4300:e=>{"use strict";e.exports=require("buffer")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},994:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>l.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>c,routeModule:()=>x,tree:()=>o});var r=s(7096),a=s(6132),i=s(7284),l=s.n(i),d=s(2564),n={};for(let e in d)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>d[e]);s.d(t,n);let o=["",{children:["budget",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,1437)),"F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\budget\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,9113)),"F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,9291,23)),"next/dist/client/components/not-found-error"]}],c=["F:\\00. Проекты веб дизайна и другое\\OZOBID\\OZOBID-Railway\\src\\app\\budget\\page.tsx"],u="/budget/page",m={require:s,loadChunk:()=>Promise.resolve()},x=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/budget/page",pathname:"/budget",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},3568:(e,t,s)=>{Promise.resolve().then(s.bind(s,9894))},9894:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>page});var r=s(784),a=s(9885),i=s(6558),l=s(9994),d=s(5413);let components_BudgetMonitor=({userId:e,storeId:t,credentials:s,performanceCredentials:i,dailyLimit:n,warningThreshold:o,autoDisable:c,onBudgetExceeded:u})=>{let[m,x]=(0,a.useState)(0),[p,g]=(0,a.useState)(0),[h,b]=(0,a.useState)(!1),[f,y]=(0,a.useState)(!1),[_,j]=(0,a.useState)(!1),[v,w]=(0,a.useState)(null),[N,S]=(0,a.useState)(null),checkBudget=async()=>{j(!0),S(null);try{let{data:r,error:a}=await d.OQ.from("budget_monitoring").select("*").eq("user_id",e).eq("store_id",t).single();if(a)throw Error(a.message);if(c){let{data:r,error:a}=await (0,l.aj)(s,i,n,c);if(a)throw Error(a);r&&(x(r.totalSpent||0),g((r.totalSpent||0)/n*100),b((r.totalSpent||0)>=n*o/100),y(r.budgetExceeded||!1),w(new Date().toISOString()),r.budgetExceeded&&u&&u(),await d.OQ.from("budget_monitoring").upsert({user_id:e,store_id:t,total_spent:r.totalSpent||0,budget_exceeded:r.budgetExceeded||!1,last_checked:new Date().toISOString()}))}else r&&(x(r.total_spent||0),g((r.total_spent||0)/n*100),b((r.total_spent||0)>=n*o/100),y(r.budget_exceeded||!1),w(r.last_checked))}catch(e){S(`Ошибка при проверке бюджета: ${e.message}`)}finally{j(!1)}};return(0,a.useEffect)(()=>{checkBudget();let e=setInterval(checkBudget,18e5);return()=>clearInterval(e)},[e,t,n,o,c]),(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[r.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Мониторинг дневного бюджета"}),N&&r.jsx("div",{className:"p-4 mb-4 rounded bg-red-100 text-red-700",children:N}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("div",{className:"flex justify-between mb-2",children:[(0,r.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["Потрачено: ",m.toFixed(2)," ₽ из ",n.toFixed(2)," ₽"]}),(0,r.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:[p.toFixed(1),"%"]})]}),r.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:r.jsx("div",{className:`h-2.5 rounded-full ${f?"bg-red-600":h?"bg-yellow-500":"bg-green-600"}`,style:{width:`${Math.min(p,100)}%`}})})]}),(0,r.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-center mb-4",children:[r.jsx("div",{className:"mb-4 md:mb-0",children:r.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${f?"bg-red-100 text-red-800":h?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:f?"Бюджет превышен":h?"Приближается к лимиту":"В пределах бюджета"})}),r.jsx("div",{className:"text-sm text-gray-500",children:v&&`Последняя проверка: ${new Date(v).toLocaleString()}`})]}),r.jsx("button",{onClick:checkBudget,disabled:_,className:"w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 disabled:opacity-50",children:_?"Проверка...":"Проверить сейчас"})]})},components_BudgetSettingsForm=({userId:e,credentials:t})=>{let[s,n]=(0,a.useState)([]),[o,c]=(0,a.useState)(!1),[u,m]=(0,a.useState)(""),[x,p]=(0,a.useState)(null),[g,h]=(0,a.useState)(!1),[b,f]=(0,a.useState)("default"),[y,_]=(0,a.useState)({clientId:t.clientId,apiKey:t.apiKey}),{register:j,handleSubmit:v,setValue:w,watch:N,formState:{errors:S}}=(0,i.cI)(),q=N("isActive"),k=N("dailyLimit")||0,O=N("notificationThreshold")||80;(0,a.useEffect)(()=>{let loadData=async()=>{c(!0);let{data:s,error:r}=await (0,l.x)(t);r?m("Ошибка при загрузке кампаний: "+r.message):s&&n(s.campaigns||[]);let{data:a,error:i}=await (0,d.m1)(e);i?m("Ошибка при загрузке настроек бюджета: "+i.message):a&&(w("dailyLimit",a.daily_limit||0),w("notificationThreshold",a.notification_threshold||80),w("isActive",void 0===a.is_active||a.is_active),a.store_id&&f(a.store_id),a.performance_client_id&&a.performance_api_key&&_({clientId:a.performance_client_id,apiKey:a.performance_api_key})),c(!1)};loadData()},[e,t,w]);let handleCampaignSelect=e=>{p(e);let t=s.find(t=>t.id===e);t&&w("campaignBudget",t.dailyBudget||0)},onSubmit=async s=>{c(!0),m("");try{let{error:r}=await (0,d.rO)(e,{daily_limit:s.dailyLimit,notification_threshold:s.notificationThreshold,is_active:s.isActive,store_id:b,performance_client_id:y.clientId,performance_api_key:y.apiKey});if(r)throw Error("Ошибка при обновлении настроек бюджета: "+r.message);if(x){let{error:e}=await (0,l.kC)(t,x,s.campaignBudget);if(e)throw Error("Ошибка при обновлении бюджета кампании: "+e.message)}m("Настройки бюджета успешно обновлены")}catch(e){m(e.message)}finally{c(!1)}};return r.jsx("div",{className:"max-w-4xl mx-auto",children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[r.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Настройки бюджета"}),u&&r.jsx("div",{className:`p-4 mb-4 rounded ${u.includes("Ошибка")?"bg-red-100 text-red-700":"bg-green-100 text-green-700"}`,children:u}),(0,r.jsxs)("form",{onSubmit:v(onSubmit),children:[(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Общий дневной лимит (руб.)"}),r.jsx("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",...j("dailyLimit",{required:"Это поле обязательно",min:{value:0,message:"Значение должно быть положительным"}})}),S.dailyLimit&&r.jsx("p",{className:"text-red-500 mt-1",children:S.dailyLimit.message})]}),(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Порог уведомления (%)"}),r.jsx("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",...j("notificationThreshold",{required:"Это поле обязательно",min:{value:1,message:"Минимальное значение 1%"},max:{value:100,message:"Максимальное значение 100%"}})}),S.notificationThreshold&&r.jsx("p",{className:"text-red-500 mt-1",children:S.notificationThreshold.message})]}),r.jsx("div",{className:"mb-4",children:(0,r.jsxs)("label",{className:"flex items-center text-gray-700 mb-2",children:[r.jsx("input",{type:"checkbox",className:"mr-2",...j("isActive")}),"Автоматически отключать кампании при превышении лимита"]})}),(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Выберите кампанию для настройки бюджета"}),(0,r.jsxs)("select",{className:"w-full px-3 py-2 border rounded-md",onChange:e=>handleCampaignSelect(e.target.value),defaultValue:"",children:[r.jsx("option",{value:"",disabled:!0,children:"Выберите кампанию"}),s.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.name," (","active"===e.state?"активна":"приостановлена",")"]},e.id))]})]}),x&&(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-gray-700 mb-2",children:"Дневной бюджет кампании (руб.)"}),r.jsx("input",{type:"number",className:"w-full px-3 py-2 border rounded-md",...j("campaignBudget",{required:"Это поле обязательно",min:{value:0,message:"Значение должно быть положительным"}})}),S.campaignBudget&&r.jsx("p",{className:"text-red-500 mt-1",children:S.campaignBudget.message})]}),r.jsx("button",{type:"submit",className:"w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md",disabled:o,children:o?"Сохранение...":"Сохранить настройки"}),r.jsx("button",{type:"button",className:"w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md",onClick:()=>h(!g),children:g?"Скрыть мониторинг":"Показать мониторинг"})]})]}),g&&r.jsx("div",{children:r.jsx(components_BudgetMonitor,{userId:e,storeId:b,credentials:t,performanceCredentials:y,dailyLimit:k,warningThreshold:O,autoDisable:q})})]})})},page=()=>{let[e,t]=(0,a.useState)(null),[s,i]=(0,a.useState)(null),[l,n]=(0,a.useState)(!0),[o,c]=(0,a.useState)(null);return((0,a.useEffect)(()=>{let checkAuth=async()=>{try{n(!0);let{data:{user:e},error:s}=await d.OQ.auth.getUser();if(s)throw Error("Ошибка авторизации: "+s.message);if(!e)throw Error("Необходимо авторизоваться");t(e.id);let{data:r,error:a}=await d.OQ.from("ozon_credentials").select("*").eq("user_id",e.id).eq("is_active",!0).single();if(a&&"PGRST116"!==a.code)throw Error("Ошибка при получении учетных данных: "+a.message);if(!r)throw Error("Необходимо добавить учетные данные OZON");i({clientId:r.client_id,apiKey:r.api_key})}catch(e){c(e.message)}finally{n(!1)}};checkAuth()},[]),l)?r.jsx("div",{className:"flex justify-center items-center min-h-screen",children:r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):o?(0,r.jsxs)("div",{className:"max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md",children:[r.jsx("div",{className:"text-red-500 mb-4",children:o}),r.jsx("button",{onClick:()=>window.location.href="/",className:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",children:"Вернуться на главную"})]}):(0,r.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[r.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Управление бюджетом"}),e&&s&&r.jsx(components_BudgetSettingsForm,{userId:e,credentials:s})]})}},1437:(e,t,s)=>{"use strict";s.r(t),s.d(t,{$$typeof:()=>l,__esModule:()=>i,default:()=>n});var r=s(5153);let a=(0,r.createProxy)(String.raw`F:\00. Проекты веб дизайна и другое\OZOBID\OZOBID-Railway\src\app\budget\page.tsx`),{__esModule:i,$$typeof:l}=a,d=a.default,n=d}};var t=require("../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[472,287,558,155,863],()=>__webpack_exec__(994));module.exports=s})();